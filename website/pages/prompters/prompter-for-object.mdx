# `PrompterForObject`

## Description

A `PrompterForObject` is a `Prompter` that can generate a text based request _(prompt)_ for the AI. It receives an object as an input and returns a type safe object after it was generated by the AI.

Under the hood, it builds a prompt that contains a JSON object with the properties of the input object and request the AI to return a JSON object with the same properties as the input object but with the values generated by the AI.

Then, it validates that the response is a JSON object with the same properties as the input object using [Zod](https://github.com/colinhacks/zod), a TypeScript library for runtime type checking.

## Basic Usage

```typescript {13-21} copy
import { OpenAiClientBuilder, PrompterForObjectBuilder } from "gptyped"
import { z } from "zod"

// A Zod schema describing the type of the AI response
export const TweetSchema = z.object({
  tweet: z.string().min(1),
  tags: z.array(z.string()).min(3),
})
type Tweet = z.infer<typeof TweetSchema>

const gpTypedOpenAiClient = new OpenAiClientBuilder("YOUR_OPEN_AI_SECRET_KEY").build()

const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
}).build()

//  Use an input object to make a request to the OpenAI API. The response will be type safe.
const result = await prompterForObject.send<Tweet>({
  topic: "Why is spring the best season?",
})

// Access the Tweet type safe response
console.log(result.tweet) // "Spring is the best season because of the flowers and nature."
console.log(result.tags) // ["#spring", "#flowers", "#nature"]
```

## Options

Use the `withOptions` method to customize the `PrompterForObject` behavior.

```typescript {5-8} copy
const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withOptions({
    verbose: true,
    logPrompt: false,
  })
  .build()
```

| Property    |                                                         Description                                                         | Default |
| :---------- | :-------------------------------------------------------------------------------------------------------------------------: | ------: |
| `verbose`   | If `true`, the `PrompterForObject` will log a detail status of the request and response process with the AI to the console. | `false` |
| `logPrompt` |                      If `true`, the `PrompterForObject` will log the generated prompt to the console.                       | `false` |

## Prompt Generation

### Metaprompt

A _metaprompt_ is a text added at the top of the prompt that is used to indicate to the AI the kind of behaviour it should have when generating the response.\
For example, if you want the AI to behave like an assistant, you can use a metaprompt like `You are a professional, curious and friendly assitant having a conversation`.

```typescript {5} copy
const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withMetaprompt("You are a professional, curious and friendly assitant having a conversation")
  .build()
```

### Memory

import { Callout } from "nextra-theme-docs"

<Callout type="warning">Beta: This feature is under development and will probably change in the near future.</Callout>

Most Large Language Models (AI) do not have any memory of previous requests. Each time you make a new request, the AI will start from scratch and generate a new response without taking into consideration any previous requests or responses.

To make the AI remember previous requests and responses, you can use the `withMemory` method.

```typescript {7} copy
const memory = previousTweets.flatMap((tweet) => tweet.tweet).join(".\n")

const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withMemory(previousTweets.length > 0 ? memory : undefined)
  .build()
```

### Reminder

A reminder is added at the end of the prompt to help the AI remember a key behaviour we want it to have when generating the response.

This is useful to increase the chances of the AI returning the kind of response you expect.

<Callout type="info">
  By default, the `PrompterForObject` adds a reminder to the prompt that tells the AI to return a JSON object, but you
  can override it with your own reminder.
</Callout>

```typescript {5} copy
const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withReminder("Answer with a JSON reponse pretty please!")
  .build()
```

## Interceptors

### Raw Request Interceptor

Gives you the ability to intercept the request prompt **before** it is sent to the AI with the `client`.

```typescript {5-8} copy
const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withRawRequestInterceptor((rawRequest) => {
    console.log(rawRequest)
    return rawRequest
  }))
  .build()
```

### Raw Response Interceptor

Gives you the ability to intercept the raw generated text response as it was received by the `client` from the AI.

```typescript {5-8} copy
const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withRawResponsetInterceptor((rawResponse) => {
    console.log(rawResponse)
    return rawResponse
  }))
  .build()
```

### JSON Interceptor

When a response is received by the `client` from the AI, the `PrompterForObject` will try to detect if the text response contains a JSON structure. After a JSON structure is detected, this intereceptor will run **before** the text is parsed into an object using `JSON.parse()`.

This intereceptor gives you the ability to manipulate the JSON before it is parsed into an object.

```typescript {5-8} copy
const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withJsonInterceptor((jsonString) => {
    console.log(jsonString)
    return jsonString
  }))
  .build()
```

### Zod Schema Interceptor

Gives you the ability to intercept the response object **before** it is validated with Zod.\
Useful to inject extra properties to the response required in the Zod schema.

```typescript {8} copy
// Let's inject a date property to the response
const date = new Date().toISOString()

const prompterForObject = new PrompterForObjectBuilder(gpTypedOpenAiClient, TweetSchema, {
  tweet: "A tweet about the topic. Maximum of 140 characters.",
  tags: "3 hashtags about the tweet.",
})
  .withZodSchemaInterceptor((unsafeObject) => new Object({ ...unsafeObject, date: date }))
  .build()
```
